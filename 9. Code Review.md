# 9. 코드 리뷰

- 작성자 이외의 사람이 코드를 검토하는 프로세스로, 주로 코드를 코드베이스에 반영하기 전에 수행한다.
- 구글에서는 모든 코드 변경을 커밋 전에 검토하도록 강제하는 동시에 리뷰 프로세스를 시작하고 변경을 검토할 책임을 모든 엔지니어에게 부과한다.
- 코드 리뷰를 효과적으로 하려면 일반적으로 절차와 지원 도구를 잘 활용해야 한다.
- 구글은 자체 개발한 코드 리뷰 도구인 Critique을 이용한다.
- 코드 리뷰는 '버그가 코드베이스로 침투하기 전에 잡아낸다'처럼 확실하고 쉽게 납득되는 이점을 제공한다.

## 9.1 코드 리뷰 흐름

- 코드 리뷰의 최종 목표는 다른 엔지니어로부터 해당 변경을 적용해도 된다는 합의를 이끌어내는 것이다.
- 합의한 엔지니어는 좋아보임(looks good to me)라는 뜻의 LGTM이라는 태그를 달아 의사를 표현한다.
  - 구글 코드 리뷰의 중요한 대원칙: 코드가 완벽하지 않더라도 전체적인 품질을 높이는 상태에 도달했다면 리뷰어는 그 코드를 승인하는 방향으로 검토한다.

### 구글 코드 리뷰 절차

1. 작성자가 자신의 작업 공간에서 코드베이스에 적용할 변경사항을 작성한다. 그런 다음 변경의 스냅샷을 만든다. 여기서 스냅샷이란 코드 리뷰 도구에 업로드할 코드 패치와 관련된 설명이다. 이 변경으로 현재 코드베이스와의 diff를 떠서 코드가 어떻게 달라졌는지를 평가한다.
2. 작성자는 초기 패치를 사용하여 자동 리뷰 의견을 받거나 스스로 리뷰를 해본다. 변경 내용이 만족스럽다면 한 명 이상의 리뷰어에게 메일을 보내 리뷰를 요청한다. 메일을 받은 리뷰어들에게 스냅샷을 보고 리뷰 의견을 달라는 뜻이다.
3. 리뷰어들은 코드 리뷰 도구에서 변경을 열고 해당 diff에 댓글로 의견을 남긴다. 작성자에게 해결해야 할 문제를 던져주거나, 단순히 유용한 정보를 제공해주기도 한다.
4. 작성자는 피드백을 기초로 변경을 수정하고 새로운 스냅샷을 업로드한 후 리뷰어들에게 회신한다. 3~4단계는 여러차례 반복될 수 있다.
5. 리뷰어들이 변경 내용에 모두 만족하면 LGTM 태그를 달아준다. 보통은 모든 리뷰어가 LGTM을 달아주는 게 관례지만 원칙적으로는 한 개만 얻어도 된다.
6. 변경에 LGTM이 달리고 모든 댓글을 해결하고 변경이 승인되면 작성자는 코드베이스에 커밋할 수 있다.

## 9.2 코드 리뷰 @구글

- 구글에서 코드 리뷰를 어떻게 진행할까? 구글의 방식이 시간과 규모 측면에서 확장하기 용이한 이유는 무엇일까?
- 구글에서는 어떤 변경이든 승인을 얻으려면 세 가지 측면에서의 리뷰를 통과해야 한다.
  1. 다른 엔지니어로부터 정확성과 이해 용이성을 평가받는다. 즉, 작성자가 의도한 작업을 코드가 적절하게 수행하는지를 본다. 필수는 아니지만 이 평가는 팀원이 해주는 경우가 많다. 이 항목은 동료 리뷰어가 코드가 충분히 괜찮아 보인다는 뜻으로 설정하는 LGTM 허가 플래그에 반영된다.
  2. 변경되는 코드 영역을 관리하는 코드 소유자로부터 변경 코드가 적절하다는 (그리고 특정 디렉터리에 체크인해도 좋다는) 승인을 받는다. 변경 작성자가 코드 소유자라면 이 승인은 묵시적으로 받은 게 된다. 구글 코드베이스는 트리 구조로 되어 있고, 디렉터리별 소유자들이 계층적으로 할당되어 있다. 그리고 소유자는 자신이 맡은 디렉터리의 문지기 역할을 한다. 변경은 아무 엔지니어나 제안할 수 있고 LGTM도 제안자 외의 모든 엔지니어가 달 수 있다. 하지만 코드베이스에 변경을 반영하려면 해당 디렉터리 소유자의 승인이 반드시 필요하다. 소유자 역할은 테크 리드나 해당 영역의 기술 전문가가 맡는다. 소유권을 얼마나 넓게 혹은 좁게 배정할지는 각 팀이 결정한다.
  3. 누군가로부터 가독성 승인을 받는다. 즉, 변경 코드가 해당 언어의 스타일과 모범 사례를 잘 따르고 조직에서 기대하는 방식으로 작성되었는지를 검사받는다. 변경 작성자가 가독성 인증자라면 가독성 승인 역시 묵시적으로 이루어진다. 가독성 검토를 해줄 엔지니어는 해당 언어 가독성 인증자 풀에서 선정한다.
- 대부분의 리뷰는 세 역할을 모두 수행할 수 있는 한 명이 처리하기 때문에 이 절차들이 빠르게 진행된다.

## 9.3 코드 리뷰의 이점

- 코드가 정확한지 확인해준다.
- 변경된 코드를 다른 엔지니어도 잘 이해한다.
- 코드베이스가 일관되게 관리된다.
- 팀이 주인의식을 더 강하게 느낀다.
- 지식이 공유된다.
- 코드 리뷰 자체의 기록이 남는다.

### 9.3.1 코드 정확성

- 리뷰어는 일차적으로 변경된 코드의 정확성을 확인해준다.
- 리뷰어는 일반적으로 해당 변경에 적합한 테스트가 갖춰졌는지, 설계는 적절한지, 정확하게 동작하고 효율적인지를 살핀다.
- 정확성 검사는 변경이 코드베이스에 버그를 심지 않도록 걸러주는 역할을 한다.
- 정확성 평가가 주관적으로 흘러가지 않도록 하기 위해 일반적으로 변경 작성자가 선택한 방식을 존중해준다.
- 리뷰어가 대안을 제시하는 것은 가능하나 이해하기 더 쉽거나 기능을 개선하는 대안일 경우에만 그리 해야 한다.
- 새로운 코드가 완벽하다고 합의될 때까지 기다리지 않고 코드베이스를 개선한다고 인정되면 변경을 승인하도록 안내한다.

### 9.3.2 코드 이해 용이성

- 작성자의 관점에 치우치지 않은 피드백을 제공한다.
- 리뷰어는 작성자가 선택한 설계를 존중해야 한다. 하지만 그와 별개로, 코드가 잘 이해되지 않으면 '고객은 항상 옳다'는 관점에서 질문을 던져보는 건 좋다.
- 비판이 있다고 해서작성자가 기존 접근법이나 로직을 꼭 바꿔야 하는 건 아니다. 다만 설명을 더 명확하게 해야 할 필요는 있을 것.

### 9.3.3 코드 일관성

- 규모가 커지면 우리가 작성한 코드를 결국은 다른 사람이 이용하게 되고 다른 사람이 유지보수하게 될 것이다. 우리가 낳은 코드를 수많은 살마이 읽고 이해해야 한다는 뜻이다.
- 따라서 코드는 일정한 표준을 따라야 하며 그래야 조직 안에서 이해되고 유지보수될 수 있다.
- 가독성 승인자의 임무는 주어진 코드가 다음 사항을 잘 만족하는지를 검토하는 것.
  - 해당 프로그래밍 언어의 모범 사례들을 잘 따라야 한다.
  - 구글 코드 리포지터리에서 같은 언어로 작성된 다른 코드들과 일관되어야 한다.
  - 필요 이상으로 복잡하지 않아야 한다.

### 9.3.4 심리적, 문화적 이점

- 소프트웨어 엔지니어에게 코드는 '자신의 것'이 아니라 협업을 통해 만들어지는 '조직의 공동 소유물'이다.
- 코드 리뷰는 작성자가 다른 사람의 피드백을 받아들이고, 또 더 큰 이익을 위해 적절히 타협하도록 이끌어준다.
- 비판받는 자리에 자신의 코드를 내어놓고 싶어 하지 않고 자신의 코드에 대한 비판적 피드백이 달갑지 않지만, 코드 리뷰는 이럴 때 자칫 감정적으로 번질 수 있는 논쟁을 건전하게 만들어 준다.
- 코드 리뷰 프로세스 자체가 나쁜 경찰 역할을 맡아주는 덕분에 리뷰어는 여전히 좋은 경찰로 남을 수 있다.
- 코드 리뷰는 작업 결과를 검증하고 인정해주는 효과가 있다.
- 리뷰 과정에서 종종 아이디어를 교환하고 지식을 공유하게 되어 리뷰어와 작성자 모두에게 이롭다.
- 엔지니어의 도메인 지식이 깊어짌부록 한 단계 더 성장시키는 긍정적인 피드백을 주기가 어려워질 때가 많아진다. 이럴 때 코드 리뷰 프로세스가 필요한 메커니즘을 제공할 수 있다.
- 리뷰 요청에 필요한 항목들을 점검하다 보면 준비가 충분하지를 엔지니어 스스로 다시 살펴보게 하는 심리적인 효과가 있다.

### 9.3.5 지식 공유

- 리뷰 프로세스는 제안, 신기술 소개, 조언을 통해 리뷰어가 변경 작성자에게 도메인 지식을 전파하도록 이끌어준다. 리뷰어는 작성자를 도와줄 생각으로 가볍게 FYI 주석을 남길 수 있다.
- 코드 리뷰 중 피드백을 주고받는 과정에서 그 변경이 특정 방식을 선택한 이유를 물어볼 수 있다. 정보가 교환되며 지식 공유를 촉진시킨다.
- 코드 리뷰에서 양방향 정보 교환이 이루어진다. 작성자는 물론 리뷰어도 새로운 기술이나 패턴을 배울 수 있다.
- 구글에서는 엔지니어라면 누구나 코드베이스를 살펴보면서 특정 패턴이 도입된 시기와 당신의 코드 리뷰에서 어떤 질문이 오고 갔는지 확인할 수 있다.

## 9.4 코드 리뷰 모범 사례

- 코드 리뷰로부터 투자한 시간만큼의 가치를 뽑아내려면 수많은 모범 사례를 알고 적용해야 한다.

### 9.4.1 공손하고 전문가답게

- 일반적으로 리뷰어들은 작성자가 선택한 방식을 존중하고 오직 그 방식에 결함이 있을 때만 대안을 제시해야 한다.
- 작성자가 다른 대안 중 특별히 더 우수한 게 없음을 설명할 수 있다면 리뷰어들은 작성자의 취향을 받아들여야 한다.
- 작성자가 선택한 방식에서 결함을 찾게 되면 작성자와 리뷰어 모두 배움의 기회로 생각하면 된다.
- 리뷰어는 작성자의 방식에 대해 성급히 결론짓지 않게 주의해야 한다. 그 방식이 잘못되었다고 가정하기 전에 그렇게 처리하게 된 이유가 무엇인지부터 물어보는 게 좋다.
- 리뷰어는 신속하게 피드백해야 한다. 구글에서는 코드 리뷰 피드백이 24시간 내에 올 거라 기대한다. 그 안에 피드백하지 못할 것 같은 리뷰어는 '변경을 확인은 했고, 최대한 조속히 검토해보겠다'라고 응답해주는 게 좋다.
- 나와 나의 코드를 동일시하지 말고, 내가 제안한 변경은 혼자의 것이 아닌 팀의 소유임을 잊지 말자.
- 코드 리뷰 과정에서 리뷰어가 단 댓글은 모두 할일로 취급해야 한다. 댓글을 의문 없이 수용할 필요는 없지만, 적어도 고민은 해봐야 한다. 동의하지 않는 댓글이라면 리뷰어에게 그 사실과 이유를 알린다. 그리고 양측 모두 대안을 제시할 기회를 준 다음에야 완료 처리해야 한다.
- 소유한 코드베이스를 외부의 누군가가 변경하려는 경우에도 제안자의 견해에 수용적인 자세로 응해야 한다.

### 9.4.2 작게 변경하기

- 리뷰어에게나 작성자에게나 코드 리뷰는 단 하나의 문제만을 다루는 게 가장 이상적이다.
- 구글은 거대한 변경을 지양하며, 리뷰어는 큰 변경에 대해서는 거부할 권한이 있다.
- 변경량이 적다면 버그가 생겻을 때 살펴볼 코드도 그만큼 적어진다.
- 커다란 기능을 새로 도입할 때는 작은 변경들로 대응하기가 어렵다. 별도 브랜치에서 개발 후 병합하는 방식. 감당해야 할 부담이 그만큼 늘어나는 것을 피할 수는 없기 때문에 프로세스를 작은 변경에 적합하게끔 최적화하는 동시에 가끔 일어나는 큰 변경도 수용할 수 있게 하면 좋을 것이다.
- 작은 변경이라 하면 일반적으로 변경되는 코드가 약 200줄 이하라는 뜻이다. 작은 변경은 리뷰어의 부담을 줄여준다.
- 변경이 작으면 승인을 책임지는 리뷰어들도 승인 여부를 더 신속하게 판단할 수 있다.

### 9.4.3 변경 설명 잘쓰기

- 변경 설명의 첫 줄은 어떤 종류의 변경인지를 잘 요약해야 한다.
- 첫 줄이 변경 전체를 요약해주지만, 구체적으로 무엇을 왜 변경하는지 알려주는 자세한 설명 역시 필요하다.

### 9.4.4 리뷰어는 최소한으로

- 구글에서 이루어지는 대부분의 코드 리뷰는 정확히 한 명의 리뷰어만으로 진행된다.
- 구글은 첫 번째 LGTM이 가장 중요하며, 두 번째부터는 크게 신경 쓸 만크의 가치가 없다는 것을 알아냈다. 리뷰어를 추가해서 얻는 가치보다 비용이 훨씬 빠르게 증가하여 금세 역전된다.
- 때에 따라서는 여럿이 검토하는 게 나은 변경도 있다. 하지만 이 경우 리뷰어들은 서로 다른 관점에서 바라보도록 역할을 조율한 후 진행해야 한다.

### 9.4.5 가능한 한 자동화하기

- 프로세스 중 자동화할 수 있는 요소가 있다면 자동화하라. 기계적인 작업을 찾아서 도구에 맡기면 투자한 만큼 거두게 될 것이다.

## 9.5 코드 리뷰 유형

코드 리뷰 유형에 따라 리뷰 프로세스의 어느 측면에 더 집중해야 하는지가 달라진다.

- 그린필드 리뷰와 새로운 기능 개발
- 동작 변경, 개선, 최적화
- 버그 수정과 롤백
- 리팩터링과 대규모 변경

### 9.5.1 그린필드 코드 리뷰

- 완전히 새로운 코드를 대상으로 하는 가장 드문 유형의 코드 리뷰
- 대상 코드가 오랜 기간 존속될 수 있는지를 평가하기에 가장 중요한 기회이다.
- 코드는 시간이 흐르고 프로젝트 규모가 커져 초기에 내린 가정들이 변해도 여전히 유지보수하기 쉬워야 한다.
- 코드가 지속 가능함을 보장하려면 API가 합의한 설계에 부합하고 테스트도 완벽히 이루어졌는지를 그린필드 리뷰에서 확인해야 한다. 
- 설계 문서도 함께 검토하기도 하고, 공개된 모든 API에 단위 테스트가 존재해야 하며, 이 테스트들은 코드의 가정이 달라지면 실패해야 한다.
- 코드를 책임질 알맞은 소유자가 배정되어야 하고, 주석도 충분해야 하고, 필요하면 보충 문서도 제공해야 한다.

### 9.5.2 동작 변경, 개선, 최적화

- API 수정, 기존 구현 개선, 성능 최적화
- 그린필드 리뷰의 지침이 그대로 적용된다. 꼭 필요한 변경인지, 코드베이스를 개선하는지를 살핀다.
- 가장 바람직한 변경은 삭제다.
- API의 동작을 수정할 때는 변경된 동작에 맞게 관련 테스트도 함께 수정해야 한다.
- 동작 변경 없이 구현 방식만 개선한 경우라면 지속적 통합 시스템을 거쳐 기존 테스트들이 모두 통과하는지 확인해야 한다.

### 9.5.3 버그 수정과 롤백

- 버그를 수정하면서 다른 문제까지 묶어 처리하고픈 마음을 꾹 눌러야 한다. 여러 주제가 섞이면 리뷰할 게 많아지는 건 둘째 치고, 회귀 테스트나 롤백을 훨씬 어렵게 만든다.
- 버그 수정 시 테스트도 보강한다. 버그가 새로 발견된 이유는 기존 테스트들이 충분하지 못했거나 특정 가정이 어긋났기 때문이다.
- 잠재적으로 롤백을 유발할 수 있는 모든 변경은 가능한 한 작고 원자적이어야 한다. 그래야 혹시라도 있을 롤백으로 인해 해당 코드를 사용하던 다른 모듈이나 프로젝트들이 망가지는 문제를 막을 수 있다.

### 9.5.4 리팩터링과 대규모 변경

- 기계(도구)가 생성한 변경도 리뷰가 필요하다. 위험성이 낮다고 생각되는 변경은 해당 코드에 관한 전권을 가진 리뷰어가 맡아서 처리한다. 하지만 위험도가 높거나 도메인 전문가가 필요한 변경들은 다른 엔지니어들도 리뷰에 참여한다.
- 자동 생성된 변경이라도 리뷰어가 정확성과 적용 가능성을 확인한다.
- 댓글을 다는 건 지양한다. 기반 도구나 변경들을 생성한 LSC 자체에는 신경 쓰지 말고 리뷰어 자신의 코드와 관련된 문제만 신경쓴다.

## 9.6 마치며

- 코드 리뷰는 엔지니어들을 이어주는 매개체이자, 테스트, 정적 분석, 지속적 통합 등 거의 모든 다른 프로세스가 엮여있는 최우선 개발 워크플로이다.
- 코드 리뷰 프로세스는 확장이 매끄럽게 이루어져야 한다. 따라서 작은 변경, 빠른 피드백과 반복 같은 모범 사례가 엄격히 지켜져야 한다. 그래야 개발자의 만족도와 생산속도가 유지된다.

## 9.7 핵심 정리

- 코드베이스 전반의 정확성, 이해 용이성, 일관성 보장 등 코드 리뷰가 주는 이점이 많다.
- 여러분의 가정에 대해 항시 다른 사람의 검토를 받도록 하고, 코드를 읽는 사람에게 최적화한다.
- 전문가다움을 지키면서 중요한 피드백을 받을 기회를 제공하라.
- 코드 리뷰는 지식을 조직 전체에 공유하는 데도 중요한 역할을 한다.
- 코드 리뷰 프로세스를 확장하려면 자동화가 아주 중요하다.
- 코드 리뷰 자체가 변경 이력이 되어준다.
