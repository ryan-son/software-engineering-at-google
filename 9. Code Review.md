# 9. 코드 리뷰

- 작성자 이외의 사람이 코드를 검토하는 프로세스로, 주로 코드를 코드베이스에 반영하기 전에 수행한다.
- 구글에서는 모든 코드 변경을 커밋 전에 검토하도록 강제하는 동시에 리뷰 프로세스를 시작하고 변경을 검토할 책임을 모든 엔지니어에게 부과한다.
- 코드 리뷰를 효과적으로 하려면 일반적으로 절차와 지원 도구를 잘 활용해야 한다.
- 구글은 자체 개발한 코드 리뷰 도구인 Critique을 이용한다.
- 코드 리뷰는 '버그가 코드베이스로 침투하기 전에 잡아낸다'처럼 확실하고 쉽게 납득되는 이점을 제공한다.

## 9.1 코드 리뷰 흐름

- 코드 리뷰의 최종 목표는 다른 엔지니어로부터 해당 변경을 적용해도 된다는 합의를 이끌어내는 것이다.
- 합의한 엔지니어는 좋아보임(looks good to me)라는 뜻의 LGTM이라는 태그를 달아 의사를 표현한다.
  - 구글 코드 리뷰의 중요한 대원칙: 코드가 완벽하지 않더라도 전체적인 품질을 높이는 상태에 도달했다면 리뷰어는 그 코드를 승인하는 방향으로 검토한다.

### 구글 코드 리뷰 절차

1. 작성자가 자신의 작업 공간에서 코드베이스에 적용할 변경사항을 작성한다. 그런 다음 변경의 스냅샷을 만든다. 여기서 스냅샷이란 코드 리뷰 도구에 업로드할 코드 패치와 관련된 설명이다. 이 변경으로 현재 코드베이스와의 diff를 떠서 코드가 어떻게 달라졌는지를 평가한다.
2. 작성자는 초기 패치를 사용하여 자동 리뷰 의견을 받거나 스스로 리뷰를 해본다. 변경 내용이 만족스럽다면 한 명 이상의 리뷰어에게 메일을 보내 리뷰를 요청한다. 메일을 받은 리뷰어들에게 스냅샷을 보고 리뷰 의견을 달라는 뜻이다.
3. 리뷰어들은 코드 리뷰 도구에서 변경을 열고 해당 diff에 댓글로 의견을 남긴다. 작성자에게 해결해야 할 문제를 던져주거나, 단순히 유용한 정보를 제공해주기도 한다.
4. 작성자는 피드백을 기초로 변경을 수정하고 새로운 스냅샷을 업로드한 후 리뷰어들에게 회신한다. 3~4단계는 여러차례 반복될 수 있다.
5. 리뷰어들이 변경 내용에 모두 만족하면 LGTM 태그를 달아준다. 보통은 모든 리뷰어가 LGTM을 달아주는 게 관례지만 원칙적으로는 한 개만 얻어도 된다.
6. 변경에 LGTM이 달리고 모든 댓글을 해결하고 변경이 승인되면 작성자는 코드베이스에 커밋할 수 있다.

## 9.2 코드 리뷰 @구글

- 구글에서 코드 리뷰를 어떻게 진행할까? 구글의 방식이 시간과 규모 측면에서 확장하기 용이한 이유는 무엇일까?
- 구글에서는 어떤 변경이든 승인을 얻으려면 세 가지 측면에서의 리뷰를 통과해야 한다.
  1. 다른 엔지니어로부터 정확성과 이해 용이성을 평가받는다. 즉, 작성자가 의도한 작업을 코드가 적절하게 수행하는지를 본다. 필수는 아니지만 이 평가는 팀원이 해주는 경우가 많다. 이 항목은 동료 리뷰어가 코드가 충분히 괜찮아 보인다는 뜻으로 설정하는 LGTM 허가 플래그에 반영된다.
  2. 변경되는 코드 영역을 관리하는 코드 소유자로부터 변경 코드가 적절하다는 (그리고 특정 디렉터리에 체크인해도 좋다는) 승인을 받는다. 변경 작성자가 코드 소유자라면 이 승인은 묵시적으로 받은 게 된다. 구글 코드베이스는 트리 구조로 되어 있고, 디렉터리별 소유자들이 계층적으로 할당되어 있다. 그리고 소유자는 자신이 맡은 디렉터리의 문지기 역할을 한다. 변경은 아무 엔지니어나 제안할 수 있고 LGTM도 제안자 외의 모든 엔지니어가 달 수 있다. 하지만 코드베이스에 변경을 반영하려면 해당 디렉터리 소유자의 승인이 반드시 필요하다. 소유자 역할은 테크 리드나 해당 영역의 기술 전문가가 맡는다. 소유권을 얼마나 넓게 혹은 좁게 배정할지는 각 팀이 결정한다.
  3. 누군가로부터 가독성 승인을 받는다. 즉, 변경 코드가 해당 언어의 스타일과 모범 사례를 잘 따르고 조직에서 기대하는 방식으로 작성되었는지를 검사받는다. 변경 작성자가 가독성 인증자라면 가독성 승인 역시 묵시적으로 이루어진다. 가독성 검토를 해줄 엔지니어는 해당 언어 가독성 인증자 풀에서 선정한다.
- 대부분의 리뷰는 세 역할을 모두 수행할 수 있는 한 명이 처리하기 때문에 이 절차들이 빠르게 진행된다.
